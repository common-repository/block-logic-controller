(()=>{"use strict";const e=window.React,l=window.wp.hooks,t=window.wp.data,o=window.wp.compose,r=window.wp.blockEditor,c=window.wp.components,n=window.wp.i18n,a=window.wp.blocks;function i({attributes:l,setAttributes:o,clientId:i}){const{updateBlockAttributes:s}=(0,t.useDispatch)(r.store),{logic:g}={...l},{action:d="show",ifs:u="all",criteria:m={},replacer:b=""}={...g},_=(e,t)=>{let r={...l.logic};r[e]=t,o({logic:r})},k=(e,t="")=>{let r={...l.logic};if(r.criteria.hasOwnProperty(e))r.criteria[e]=t;else{let l=w.filter((l=>l.value===e));r.criteria[e]=l[0].default}o({logic:r})};let p=wp.data.useSelect("core/block-editor").getBlocks();const h=[];p.length&&p.forEach((e=>{if(e.clientId!==i&&!((e,l)=>{let t=!1;return l.innerBlocks.length&&l.innerBlocks.forEach((l=>{t=l.clientId===e})),t})(i,e)){const l=(0,a.getBlockType)(e.name),t=(e=>{let l=(0,a.getBlockContent)(e).replace(/<[^>]*>?/gm,"");return l=l.length?" - "+l:l,l.length>23?l.slice(0,23)+"...":l})(e),o=e.attributes.hasOwnProperty("logicId")?e.attributes.logicId:e.clientId;h.push({label:l.title+t,value:o})}}));const w=[{label:(0,n.__)("User logged","block-logic-controller"),value:"user_logged",default:!0},{label:(0,n.__)("User roles","block-logic-controller"),value:"user_roles",default:{query:"roles_in",roles:[]}},{label:(0,n.__)("User meta key","block-logic-controller"),value:"user_meta",default:{query:"have_meta",meta:[]}},{label:(0,n.__)("Using mobile devices","block-logic-controller"),value:"is_mobile",default:!0}];Object.keys(m).length&&Object.keys(m).forEach((e=>{let l=w.findIndex((l=>l.value===e));w[l].disabled=!0}));const E=Object.keys(m).length&&Object.keys(m).map((t=>(0,e.createElement)("li",{key:"criteria-"+t},(0,e.createElement)("span",{className:"dashicons dashicons-trash",onClick:()=>(e=>{let t={...l.logic};delete t.criteria[e],o({logic:t})})(t)}),(l=>{switch(l){case"user_roles":return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(c.SelectControl,{value:m[l].query,options:[{label:(0,n.__)("User roles in","block-logic-controller"),value:"roles_in"},{label:(0,n.__)("User roles not in","block-logic-controller"),value:"roles_not_in"}],onChange:e=>{let t=m[l];t.query=e,k(l,t)},__nextHasNoMarginBottom:!0}),(0,e.createElement)(c.SelectControl,{multiple:!0,help:(0,n.__)("Select the roles to include or exclude. Use keyboard ctrl or command and mouse click multiple roles.","block-logic-controller"),value:m[l].roles,options:blctrl.roles,onChange:e=>{let t=m[l];t.roles=e,k(l,t)},__nextHasNoMarginBottom:!0}));case"user_meta":return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(c.SelectControl,{value:m[l].query,help:(0,n.__)("Select users meta key to include or exclude. Use keyboard ctrl or command and click multiple meta.","block-logic-controller"),options:[{label:(0,n.__)("Users have all of these meta keys","block-logic-controller"),value:"have_meta"},{label:(0,n.__)("Users don't have all of these meta keys","block-logic-controller"),value:"not_have_meta"}],onChange:e=>{let t=m[l];t.query=e,k(l,t)},__nextHasNoMarginBottom:!0}),(0,e.createElement)(c.SelectControl,{multiple:!0,value:m[l].user_meta,options:blctrl.user_meta.map((e=>({label:e,value:e}))),onChange:e=>{let t=m[l];t.meta=e,k(l,t)},__nextHasNoMarginBottom:!0}));case"user_logged":return(0,e.createElement)(c.ToggleControl,{__nextHasNoMarginBottom:!0,label:(0,n.__)("User logged in","block-logic-controller"),checked:m[l],onChange:e=>k(l,e)});case"is_mobile":return(0,e.createElement)(c.ToggleControl,{__nextHasNoMarginBottom:!0,label:(0,n.__)("Using mobile device","block-logic-controller"),checked:m[l],onChange:e=>k(l,e)})}})(t))));return(0,e.createElement)(r.InspectorControls,{key:"logic"},(0,e.createElement)(c.PanelBody,null,(0,e.createElement)(c.SelectControl,{label:(0,n.__)("BLock Logic Controller","block-logic-controller"),value:d,options:[{label:(0,n.__)("Select action","block-logic-controller"),value:""},{label:(0,n.__)("Show this block","block-logic-controller"),value:"show"},{label:(0,n.__)("Hide this block","block-logic-controller"),value:"hide"},{label:(0,n.__)("Replace this block with","block-logic-controller"),value:"replace"}],onChange:e=>_("action",e)}),"replace"===d&&!!h.length&&(0,e.createElement)(c.SelectControl,{value:b,options:h,onChange:e=>{let l=(new Date).getTime();const o=(0,t.select)("core/block-editor").getBlocksByClientId(e)[0];if(o){const e={...o.attributes};e.hasOwnProperty("logicId")||(e.logicId=l,s(o.clientId,e))}else l=e;_("replacer",l)}}),"replace"===d&&!h.length&&(0,e.createElement)("p",null,(0,n.__)("Please create another block to be listed here.","block-logic-controller")),!!d&&(0,e.createElement)(e.Fragment,null,(0,n.__)("If","block-logic-controller")," ",(0,e.createElement)(c.Dropdown,{label:"Use Size",popoverProps:{placement:"bottom-start"},renderToggle:({isOpen:l,onToggle:t})=>(0,e.createElement)(c.Button,{isLink:!0,style:{textDecoration:"none"},size:"medium",onClick:t,"aria-expanded":l},u," criteria"),renderContent:({onClose:l})=>(0,e.createElement)(e.Fragment,null,(0,e.createElement)(c.MenuItem,{onClick:()=>{_("ifs","all"),l()}},"all criteria"),(0,e.createElement)(c.MenuItem,{onClick:()=>{_("ifs","any"),l()}},"any criteria"))})," ",(0,n.__)("below is met.","block-logic-controller")," ",(0,e.createElement)(c.Dropdown,{popoverProps:{placement:"bottom-start"},renderToggle:({isOpen:l,onToggle:t})=>(0,e.createElement)(e.Fragment,null,(0,e.createElement)(c.Button,{style:{textDecoration:"none"},isLink:!0,size:"medium",onClick:t,"aria-expanded":l},(0,n.__)("Add criteria","block-logic-controller")),"."),renderContent:({onClose:l,isOpen:t,onToggle:o})=>w.map((t=>(0,e.createElement)(c.MenuItem,{onClick:()=>{k(t.value),l()},disabled:t.disabled?"disabled":""},t.label)))}))),E.length&&(0,e.createElement)(c.PanelBody,{className:"blctrl-criteria"},(0,e.createElement)("ul",{className:"blctrl-list"},E.map((e=>e)))))}(0,l.addFilter)("blocks.getSaveContent.extraProps","core/editor/hooks",(function(e,l,t){return t.hasOwnProperty("logicId")&&t.logicId&&(e["data-blctrl"]=t.logicId),e}),0),(0,l.addFilter)("blocks.registerBlockType","block/logic-controller",(function(e,l){return{...e,attributes:{...e.attributes,logic:{type:"object",default:{action:"",ifs:"all",criteria:{},replacer:""}},logicId:{type:"string",source:"attribute",attribute:"data-blctrl",selector:"*"}}}})),(0,l.addFilter)("editor.BlockEdit","block/logic-controller",(0,o.createHigherOrderComponent)((l=>t=>(0,e.createElement)(e.Fragment,null,(0,e.createElement)(l,{...t}),(0,e.createElement)(i,{...t})))))})();